<body class="login">
<!-- BEGIN SIDEBAR TOGGLER BUTTON -->
<div class="menu-toggler sidebar-toggler">
</div>
<!-- END SIDEBAR TOGGLER BUTTON -->
<!-- BEGIN LOGO -->
<div class="logo">
	<a href="/"><img src="https://s3.amazonaws.com/coffeemobile/logo-small.png" /></a>
</div>
<!-- END LOGO -->
<!-- BEGIN LOGIN -->
<div class="content">
	<!-- BEGIN FORGOT PASSWORD FORM -->
	<form action="/signup/<%=invite_url%>" class="forget-form" method="post" novalidate="novalidate" style="display: block;">
		<!-- BEGIN NAME -->
		<input type="hidden" name="step" value="WLT" />
		<div style="">
			<h3>Email Domain</h3>
			<p>Adding an email domain to your network's whitelist can allow your team members to discover your network more easily. It is strongly recommended if you have an organizational email address.</p>
			<div class="form-group">
				<label class="control-label visible-ie8 visible-ie9">Network</label>
				<div class="input-group">
					<span class="input-group-addon">
						@
					</span>
					<input class="form-control placeholder-no-fix" type="text" placeholder="Email Domain" name="email_domain" id="email_domain" autocomplete="off" />
				</div>
			</div>
			<p class="hint" id="domain_error" style="color:#a94442; display: none;">
				The domain you entered belongs to a public email service, we cannot whitelist these domains.
			</p>
			<p class="hint" id="domain_invalid" style="color:#a94442; display: none;">
				The domain you entered is not valid, see below for example.
			</p>
			<p class="hint">
				For example: <%=email_domain%>
			</p>
			<div>
				<ul class="media-list" id="matches">
					
				</ul>
			</div>
			<div class="form-group">
				<button type="submit" id="register-skip-btn" class="btn btn-default">Skip</button>
				<button type="submit" id="register-submit-btn" class="btn btn-success uppercase pull-right disabled">Next</button>
			</div>
		</div>
		<!-- END NAME -->
	</form>	<!-- END FORGOT PASSWORD FORM -->
</div>
<div class="copyright">
	 2014 Â© Coffee Enterprise. All Rights Reserved
</div>
<!-- END LOGIN -->
<%= javascript_include_tag "login_page" %>
<script>
jQuery(document).ready(function() {     
	Metronic.init(); // init metronic core components
	Layout.init(); // init current layout
	Login.init();
});

$("#register-skip-btn").click(function() {
	$("#email_domain").val("");
	var url = "/signup/<%=invite_url%>";
	$("form").attr("action", url);
	$("form").trigger("submit");
});

$("#email_domain").keyup(function() {
	if($(this).val().length > 0) {
		$("#email_domain").addClass("spinner")
		$("#domain_invalid").hide();
		delay(function() {
			var email = $("#email_domain").val();
			safelist(email);
		}, 800)
	} else {
		$("#email_domain").removeClass("spinner")
		$("#domain_invalid").hide();
	}
});

function safelist(email) {
	$.ajax({
		type: "POST",
		beforeSend: function (request)
		{
			request.setRequestHeader("Authorization", "Token token=b0b8ea419a31b9340b4c8bc646282f51");
		},
		url: "/api/invitations/seek_domain/",
		dataType: "json",
		data: {
			"data":email
		},
		success: function (data) {
			if(data.eXpresso.code == 0) {
				$("#email_domain").closest('.form-group').addClass('has-error');
				$("#domain_error").show();
				$("#register-submit-btn").addClass("disabled");
				$("#email_domain").removeClass("spinner")
			} else {
				$("#email_domain").closest('.form-group').removeClass('has-error');
				$("#domain_error").hide();
				if(validateEmail(email)) {
					$("#register-submit-btn").removeClass("disabled")
				} else {
					$("#domain_invalid").show();
					$("#register-submit-btn").addClass("disabled");
				}
				$("#email_domain").removeClass("spinner")
			}
		},
		error: function(e) { 
			console.log(e); 
		}
	});
}

var delay = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();

function validateEmail(email) { 
	//var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	var re = /^(?!:\/\/)([a-zA-Z0-9]+\.)?[a-zA-Z0-9][a-zA-Z0-9-]+\.[a-zA-Z]{2,6}?$/i
	return re.test(email);
} 
</script>
<!-- END JAVASCRIPTS -->
</body>